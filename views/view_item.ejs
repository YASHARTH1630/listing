<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>
        <%= item.title %>
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 min-h-screen">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 w-full bg-blue-600 text-white px-6 py-3 flex items-center justify-between shadow-md z-50">
        <div class="text-xl font-bold tracking-wide">Travels Listing</div>
        <div class="space-x-6 hidden sm:block">
            <a href="/listening" class="hover:text-yellow-300 transition">Home</a>
            <a href="/new_list" class="hover:text-yellow-300 transition">Add New Place</a>
            <% if(!currUser) { %>
                <a href="/signup" class="hover:text-yellow-300 transition">SignUp</a>
                <a href="/signup/login" class="hover:text-yellow-300 transition">Login</a>
                <% } %>
                    <% if(currUser) { %>

                        <a href="/signup/logout" class="hover:text-yellow-300 transition">Logout</a>
                        <% } %>
        </div>
    </nav>

    <!-- Main -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 pt-24 pb-12">
        <%if(success && success.length){ %>
            <h3>
                <%=success%>
            </h3>
            <% }%>
                <%if(error && error.length){ %>
                    <h3>
                        <%=error%>
                    </h3>
                    <% }%>
                        <!-- Back -->
                        <a href="/listening" class="inline-flex items-center mb-6 text-blue-600 font-medium hover:underline">
            ‚Üê Back to Listings
        </a>

                        <!-- Listing Card -->
                        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">

                            <img src="<%= item.image.url %>" alt="listing image" class="w-full h-64 sm:h-96 object-cover">

                            <div class="p-6 sm:p-8">
                                <h5>Created by
                                    <%=item.owner.username %>
                                </h5>
                                <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-2">
                                    <%= item.title %>
                                </h1>

                                <p class="text-slate-500 text-sm mb-4">
                                    üìç
                                    <%= item.location %>,
                                        <%= item.country %>
                                </p>

                                <p class="text-slate-700 leading-relaxed mb-6">

                                    <%= item.description %>
                                </p>

                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-t pt-6">

                                    <span class="text-2xl font-semibold text-emerald-600">
                        ‚Çπ <%= item.price %> / night
                    </span>
                                    <% if (currUser && item.owner && currUser._id.toString() === item.owner._id.toString()) { %>
                                        <a href="/list/<%= item._id %>/edit" class="inline-flex justify-center px-6 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition">
     Edit Listing
  </a>
                                        <% } %>


                                </div>
                            </div>
                        </div>
                        <% if (currUser) { %>

                            <!-- Review Section -->
                            <section class="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-8">

                                <!-- Add Review (FIXED HEIGHT) -->

                                <div class="bg-white rounded-xl shadow p-6 h-[380px] flex flex-col">
                                    <h2 class="text-xl font-semibold mb-4">Add a Review</h2>

                                    <form action="/listing/<%= item.id %>/reviews" method="POST" class="space-y-4 flex-1 flex flex-col">

                                        <div>
                                            <label class="block text-sm font-medium text-slate-600 mb-1">
                    Rating (1‚Äì5)
                </label>
                                            <input type="range" min="1" max="5" name="review[rating]" class="w-full accent-blue-600">
                                        </div>

                                        <div class="flex-1">
                                            <label class="block text-sm font-medium text-slate-600 mb-1">
                    Comment
                </label>
                                            <textarea name="review[comment]" class="w-full h-full resize-none rounded-lg border border-slate-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Write your experience..."></textarea>
                                        </div>

                                        <button class="mt-3 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                Submit Review
            </button>
                                    </form>
                                </div>
                                <%}%>
                                    <!-- Reviews List (SCROLLABLE) -->
                                    <div class="bg-white rounded-xl shadow p-6 h-[380px] overflow-y-auto">
                                        <h2 class="text-xl font-semibold mb-4">All Reviews</h2>

                                        <% if (item.reviews.length === 0) { %>
                                            <p class="text-slate-500">No reviews yet.</p>
                                            <% } else { %>
                                                <% let c = 0; %>
                                                    <% for (let review of item.reviews) { %>
                                                        <% c += review.rating; %>
                                                            <% } %>
                                                                <p>‚≠ê
                                                                    <%= (c / item.reviews.length).toFixed(1) %> / 5</p>

                                                                <ul class="space-y-4">
                                                                    <% for (let review of item.reviews) { %>
                                                                        <li class="border rounded-lg p-4 bg-slate-50">
                                                                            <p class="text-slate-700 mb-1 break-words">
                                                                                <%= review.comment %>
                                                                                    <h4>Created by
                                                                                        <%=review.author.username.trim()%>
                                                                                    </h4>
                                                                            </p>
                                                                            <span class="text-sm text-yellow-600 font-medium">
                    ‚≠ê <%= review.rating %> / 5
                </span>
                                                                            <% if (currUser && review.author && currUser._id.toString() === review.author._id.toString()) { %>
                                                                                <form action="/listing/<%= item._id %>/review/<%= review._id %>?_method=DELETE" method="POST">
                                                                                    <button class="bg-red-500 text-white px-3 py-1 rounded">DELETE</button>
                                                                                </form>
                                                                                <%}%>
                                                                        </li>
                                                                        <% } %>
                                                                </ul>
                                                                <% } %>
                                    </div>

                            </section>
    </main>

</body>

</html>